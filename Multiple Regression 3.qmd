---
title: "Multiple Regression 3"
subtitle: Sam Larralde and Ambrosio
format: pdf
editor: visual
---

## Activity 11: Statistical reasoning 3: multiple regression DAGs

# Install packages

# Load packages

```{r}
library(brms) # for statistics
library(tidyverse) # for data wrangling

# a function to scale and center. from rethinking package
standardize <- function(x) {
    x <- scale(x)
    z <- as.numeric(x)
    attr(z,"scaled:center") <- attr(x,"scaled:center")
    attr(z,"scaled:scale") <- attr(x,"scaled:scale")
    return(z)
}
```

# 1. DAG practice

# Question 1.1 Make Dag

```{r}
dag {
bb="0,0,1,1"
A [pos="0.436,0.218"]
B [pos="0.434,0.488"]
C [pos="0.788,0.372"]
U [pos="0.142,0.360"]
X [pos="0.160,0.701"]
Y [pos="0.794,0.691"]
A -> C
A -> U
C -> B
C -> Y
U -> B
U -> X
X -> Y
}

```

# Question 1.2 Identifying forks

## X \<- U -\> B

## U \<-A -\> C

## B \<- C -\> Y

# Question 1.3 Identify colliders

## U → B ← C

## C → Y ← X

# Question 1.4 Modify the Dag

dag { bb="0,0,1,1" A \[pos="0.436,0.218"\] B \[pos="0.434,0.488"\] C \[pos="0.788,0.372"\] U \[pos="0.142,0.360"\] V \[pos="0.656,0.526"\] X \[pos="0.160,0.701"\] Y \[pos="0.794,0.691"\] A -\> C A -\> U C -\> B C -\> Y U -\> B U -\> X V -\> C V -\> Y X -\> Y }

# Question 1.5 Identify paths

## x-\> y

## U -\> X -\> Y

## A -\> U -\> X -\> Y

# Question 1.6 Identify open backdoor paths

## U -\> X

## C -\> Y

## V -\> Y

# Question 1.7 Identify variables to close the backdoors

## U, C, Y

# Foxes: Regression Practice informed by DAGs

Load librarys

```{r}
# Load in the fox data
foxes <- read.csv('https://raw.githubusercontent.com/rmcelreath/rethinking/refs/heads/master/data/foxes.csv', sep = ';')
```

check out fox data

```{r}
# Check out the fox data
?foxes
head(foxes)
```

# Question 2.1 Identify the fundamental relations in the fox DAG

## fork; groupsize \<-avgfood -\> weight

## colider; avgfood -\> weight \<- groupsize

## pipe; area -\> avgfood -\> weight

## pipe; avgfood-\>groupsize -\> weight

# Total causal influence of area on weight

```{r}
fox_dat <- foxes %>%
  as_tibble() %>%
  select(area, avgfood, weight, groupsize) %>%
  mutate(across(everything(), standardize))
```

simulate from some priors

```{r}
n <- 1000
priorsims <- tibble(group = seq_len(n),
       alpha = rnorm(n, 0, 0.2), # prior for alpha
       beta = rnorm(n, 0, 2)) %>% # prior for beta
  expand(nesting(group, alpha, beta), # the expand function gives us all possible combinations of the arguments
         area = seq(from = -2, to = 2, length.out = 100)) %>% # set up a range of areas
  mutate(weight = alpha + beta * area) # calculate weight from the parameters and area
```

make a plot

```{r}
ggplot(priorsims, aes(x = area, y = weight, group = group)) +
  geom_line(alpha = 1 / 10) +
  labs(x = "Standardized Area", y = "Standardized Weight")
```

# Question 2.2 Minimum fox weight

## We think at minimum the fox might weight 9 kg

# Question 2.3 Maximum fox wight

## We think a reasonable maximum weight for a fox is 14g

# Question 2.4 Modify simulation plot

## min= 10kg, max = 14kg

```{r}
ggplot(priorsims, aes(x = area, y = weight, group = group)) +
  geom_line(alpha = 1 / 10) +
  labs(x = "Standardized Area", y = "Standardized Weight")
  geom_hline(y= 10)
  geom_hline(y=40)
```

```{r}
mean_w <- mean(foxes$weight)
sd_w   <- sd(foxes$weight)
min_std <- (10 - mean_w) / sd_w
max_std <- (14 - mean_w) / sd_w
ggplot(priorsims, aes(x = area, y = weight, group = group)) +
  geom_line(alpha = 1/10) +
  geom_hline(yintercept = min_std, color = "red", linetype = "dashed") +
  geom_hline(yintercept = max_std, color = "red", linetype = "dashed") +
  labs(x = "Standardized Area",
       y = "Standardized Weight")
```

# Question 2.5 **Evaluate prior predictive simulation**

The priors do not seem reasonable, as weight will not cross into negative values.

# **Q2.6 Refine priors**

```{r}
n <- 1000
priorsims <- tibble(group = seq_len(n),
       alpha = rnorm(n, 6, 0.5),# prior for alpha
       beta = rnorm(n, 0,.2)) %>% # prior for beta
  expand(nesting(group, alpha, beta), # the expand function gives us all possible combinations of the arguments
         area = seq(from = -2, to = 2, length.out = 100)) %>% # set up a range of areas
  mutate(weight = alpha + beta * area) # calculate weight from the parameters and area
```

```{r}
mean_w <- mean(foxes$weight)
sd_w   <- sd(foxes$weight)
min_std <- (10 - mean_w) / sd_w
max_std <- (14 - mean_w) / sd_w
ggplot(priorsims, aes(x = area, y = weight, group = group)) +
  geom_line(alpha = 1/10) +
  geom_hline(yintercept = min_std, color = "red", linetype = "dashed") +
  geom_hline(yintercept = max_std, color = "red", linetype = "dashed") +
  labs(x = "Standardized Area",
       y = "Standardized Weight")
```
# Run Models
```{r}
food_on_area <- brm(avgfood ~ 1 + area, 
                    data = fox_dat, 
                    family = gaussian,
                    # Here we set the priors that we investigated earlier
                    prior = c(prior(normal(6, 0.5), class = Intercept),
                              prior(normal(0,.2), class = b,),
                              prior(exponential(1), class = sigma)),
                    iter = 4000, warmup = 2000, chains = 4, cores = 4, seed = 1234,
                    file = "output/food_on_area")
```

```{r}
summary(food_on_area)
```

# **Q2.7 Run a model for the impact of food on fox weight**
```{r}
# fox weight model
m.fox.weights <- 
  brm(data = fox_dat, # Give it fox data
      # Choose a gaussian (normal) distribution
      family = gaussian,
      # Specify the model here. 
      weight ~ 1 + avgfood,
      # Here's where you specify parameters for executing the Markov chains
      # We're using similar to the defaults, except we set cores to 4 so the analysis runs faster than the default of 1
      iter = 2000, warmup = 1000, chains = 4, cores = 4,
      # Setting the "seed" determines which random numbers will get sampled.
      # In this case, it makes the randomness of the Markov chain runs reproducible 
      # (so that both of us get the exact same results when running the model)
      seed = 4,
      # Save the fitted model object as output - helpful for reloading in the output later
      file = "output/m.fox.weight")
```

```{r}
summary(m.fox.weight)
```
The slope shows a negative correlation between food and fox weight. This unexpected so something should be missing or mistaken.

# **Q2.8 Is there a variable we should condition upon?**
